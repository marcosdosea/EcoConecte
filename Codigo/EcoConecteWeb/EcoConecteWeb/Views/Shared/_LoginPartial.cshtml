@using Microsoft.AspNetCore.Identity
@using EcoConecteWeb.Areas.Identity.Data

@inject SignInManager<UsuarioIdentity> SignInManager
@inject UserManager<UsuarioIdentity> UserManager

<ul class="navbar-nav">
	@if (SignInManager.IsSignedIn(User))
	{
		@* Obtendo o usuário autenticado *@
		var usuarioAtual = await UserManager.GetUserAsync(User);
		var email = usuarioAtual?.Email;
		var nomeUsuario = email?.Split('@')[0]; // Pegando apenas a parte antes do @

		@* Obtendo as roles do usuário *@
		var roles = usuarioAtual != null ? await UserManager.GetRolesAsync(usuarioAtual) : new List<string>();

		@* Definição de Cliente: Se não for ADMROOT, COOPERADO ou COOPERATIVA, ele é Cliente *@
		var ehAdmin = roles.Contains("ADMROOT");
		var ehCooperado = roles.Contains("COOPERADO");
		var ehCooperativa = roles.Contains("COOPERATIVA");
		var ehCliente = !ehAdmin && !ehCooperado && !ehCooperativa;

		@* Saudação ao usuário *@
		<li class="nav-item">
			<span class="nav-link text-dark">Olá, @nomeUsuario</span>
		</li>

		@* Botão de logout *@
		<li class="nav-item">
			<form class="form-inline" asp-area="Identity" asp-page="/Account/Logout"
				  asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })" method="post">
				<button type="submit" class="nav-link btn btn-link text-dark border-0">Sair</button>
				@Html.AntiForgeryToken() <!-- Proteção contra CSRF -->
			</form>
		</li>

		@* Menu para CLIENTES *@
		if (ehCliente)
		{
			<li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle text-dark" href="#" id="clienteDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
					Área do Cliente
				</a>
				<ul class="dropdown-menu" aria-labelledby="clienteDropdown">
					<li><a class="dropdown-item" asp-controller="perfil" asp-action="Perfil">Perfil</a></li>
					<li><a class="dropdown-item" asp-controller="opcao" asp-action="Index">Usuário</a></li>
					<li><a class="dropdown-item" asp-controller="suporte" asp-action="Index">Suporte</a></li>
				</ul>
			</li>
		}

		@* Menu para ADMINISTRADORES *@
		if (ehAdmin)
		{
			<li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle text-dark" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
					Área Administrativa
				</a>
				<ul class="dropdown-menu" aria-labelledby="adminDropdown">
					<li><a class="dropdown-item" asp-controller="opcao" asp-action="Index">Opções</a></li>
				</ul>
			</li>
		}
		@* Menu para COOPERATIVA *@
		if (ehCooperativa)
		{
			<li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle text-dark" href="#" id="coopDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
					Área Administrativa
				</a>
				<ul class="dropdown-menu" aria-labelledby="coopDropdown">
					<li><a class="dropdown-item" asp-controller="perfil" asp-action="Perfil">Perfil</a></li>
					<li><a class="dropdown-item" asp-controller="opcao" asp-action="Index">Opções</a></li>
				</ul>
			</li>
		}
		@* Menu para COOPERADO *@
		if (ehCooperado)
		{
			<li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle text-dark" href="#" id="coopeDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
					Área Cooperado
				</a>
				<ul class="dropdown-menu" aria-labelledby="coopeDropdown">
					<li><a class="dropdown-item" asp-controller="perfil" asp-action="Perfil">Perfil</a></li>
					<li><a class="dropdown-item" asp-controller="opcao" asp-action="Index">Opções</a></li>
				</ul>
			</li>
		}
	}
	else
	{
		<li class="nav-item">
			<a class="nav-link text-dark" id="login" asp-area="Identity" asp-page="/Account/Login">Entrar</a>
		</li>
		<li class="nav-item">
			<a class="nav-link text-dark" id="register" asp-area="Identity" asp-page="/Account/Register">Registre-se</a>
		</li>
	}
</ul>
